@page "/proyecto/{id:int}/diagrama_de_gantt"
@using Dominio
@using Servicios.Gestores
@using Servicios.Utilidades
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject GestorProyectos GestorProyectos
@inject NavigationManager NavigationManager


<h3>Diagrama de Gantt</h3>
@if (!GestorProyectos.ObtenerProyectoPorId(Id).Tareas.Any())
{
    <p>Aún no se han asignado tareas al proyecto. El diagrama se actualizará cuando se añadan tareas.</p>
}
else
{
    <div id="ganttDiagrama" style="border: 1px solid #ccc; border-radius: 0.5rem; padding: 1rem; background-color: #f8f9fa;">
    </div>
    <p style="margin-top: 1rem; font-style: italic; color: #70798c; font-size: 0.95rem;">
        Las tareas del camino crítico están resaltadas en rojo.
    </p>
}

@code {
    [Parameter] public int Id { get; set; }
    private Proyecto proyecto;
    private bool graficoDibujado = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                proyecto = GestorProyectos.ObtenerProyectoPorId(Id);
            }
            catch
            {
                NavigationManager.NavigateTo("/Error");
                return;
            }
            CaminoCritico.CalcularCaminoCritico(proyecto);
            StateHasChanged(); // Asegurar que el div se renderice primero
            return; // Esperar hasta el segundo render
        }

        if (proyecto != null && !graficoDibujado)
        {
            CaminoCritico.CalcularCaminoCritico(proyecto);
            var tareas = proyecto.Tareas.Select(t => new
            {
                titulo = t.Titulo,
                fechaInicio = t.FechaInicioMasTemprana.ToString("yyyy-MM-dd"),
                fechaFin = t.FechaFinMasTemprana.AddDays(1).ToString("yyyy-MM-dd"), // añadimos un día para representar que la tarea se completa hasta el final del día
                holgura = t.Holgura
            }).ToList();

            await JSRuntime.InvokeVoidAsync("dibujarGanttConApex", "#ganttDiagrama", tareas);
            graficoDibujado = true;
        }
    }
}